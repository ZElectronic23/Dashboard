<!DOCTYPE html>
<html>
<head>
  <!-- ... نفس الـ head ... -->
</head>
<body>
  <!-- ... نفس الـ body ... -->
  <script>
    if (localStorage.getItem('userData')) {
      window.location.href = 'dashboard.html';
    }
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const loginBtn = document.getElementById('loginBtn');
      const errorMsg = document.getElementById('error-msg');
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const API_URL = "https://script.google.com/macros/s/AKfycbzcjXMeSubNDfGl0vY3-GwV29xw7SnSRj_UrsUa0mIv0MHiue5hCy79AijTNh6N793/exec"; // الرابط الجديد
      loginBtn.disabled = true;
      loginBtn.textContent = 'جاري التحقق...';
      errorMsg.textContent = '';
      const urlWithParams = new URL(API_URL );
      urlWithParams.searchParams.append('action', 'login');
      urlWithParams.searchParams.append('username', username);
      urlWithParams.searchParams.append('password', password);
      fetch(urlWithParams)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
            // **التغيير الجوهري: نحفظ كائن بيانات المستخدم بالكامل**
            localStorage.setItem('userData', JSON.stringify(data.userData));
            window.location.href = 'dashboard.html';
        } else {
            errorMsg.textContent = data.message;
            loginBtn.disabled = false;
            loginBtn.textContent = 'دخول';
        }
      })
      .catch(error => {
        errorMsg.textContent = 'فشل الاتصال. حاول مرة أخرى.';
        loginBtn.disabled = false;
        loginBtn.textContent = 'دخول';
      });
    });
  </script>
</body>
</html>
