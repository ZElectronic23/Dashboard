<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الدخول</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body{font-family:'Cairo', sans-serif; margin:0;background-image:url("https://i.ibb.co/PS9M6NX/BG2-Phone.png" );background-size:cover;background-position:center;height:100vh;display:flex;justify-content:center;align-items:center;color:white;}
    .login-box{background-color:rgba(0,0,0,.75);padding:30px 25px 35px;border-radius:18px;box-shadow:0 0 30px rgba(219,169,53,.8);width:320px;text-align:center;}
    .login-box h2{margin-bottom:25px;color:#dba935;font-weight:700;}
    input[type=email],input[type=password]{width:100%;padding:12px 15px;margin:12px 0;border-radius:10px;border:none;font-size:16px;outline:0;font-family:inherit;box-sizing:border-box;color:#fff;background-color:#222;}
    button{width:100%;padding:12px;margin-top:20px;background:linear-gradient(135deg,#dba935,#999);border:none;border-radius:10px;font-size:17px;color:#000;cursor:pointer;font-weight:700;}
    .error-msg{color:#ff6666;margin-top:10px;font-size:14px;min-height:20px;text-align:right;}
    html[dir="ltr"] .error-msg { text-align: left; }
  </style>
</head>
<body>
  <div class="login-box">
    <h2 data-translate="login_title">تسجيل الدخول</h2>
    <form id="loginForm">
      <input id="username" type="email" placeholder="اسم المستخدم" required autocomplete="username" />
      <input id="password" type="password" placeholder="كلمة المرور" required autocomplete="current-password" />
      <div id="error-msg" class="error-msg"></div>
      <button id="loginBtn" type="submit">دخول</button>
    </form>
  </div>

  <script>
    // --- التحقق من تسجيل الدخول المسبق ---
    if (localStorage.getItem('userEmail')) {
      window.location.href = 'dashboard.html';
    }

    // --- التعامل مع نموذج تسجيل الدخول ---
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const loginBtn = document.getElementById('loginBtn');
      const errorMsg = document.getElementById('error-msg');
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      const API_URL = "https://script.google.com/macros/s/AKfycbxzcjXMeSubNDfGl0vY3-GwV29xw7SnSRj_UrsUa0mIv0MHiue5hCy79AijTNh6N793/exec";

      loginBtn.disabled = true;
      loginBtn.textContent = 'جاري التحقق...';
      errorMsg.textContent = '';

      fetch(API_URL, {
        method: 'POST',
        // هذا الجزء مهم جدًا
        mode: 'no-cors', // تجاهل أخطاء CORS، لأننا لا نحتاج لقراءة الرد مباشرة هنا
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/json'
        },
        // إعادة توجيه الطلب يدويًا
        redirect: 'follow',
        // إرسال البيانات كـ JSON
        body: JSON.stringify({ action: 'login', username: username, password: password } )
      })
      // ملاحظة: بما أننا نستخدم no-cors، لا يمكننا قراءة الرد هنا.
      // سنقوم بإعادة التوجيه بناءً على ما يقوله الخادم.
      // هذا الكود يفترض أن الخادم سيرد بخطأ إذا فشل، وبنجاح إذا نجح.
      // هذا ليس مثاليًا، لكنه ضروري لتجاوز مشاكل CORS المعقدة مع Apps Script.
      // سنقوم بتحسين هذا لاحقًا.
      // حاليًا، سنفترض أن الطلب نجح وننتقل إلى الخطوة التالية.
      .then(() => {
          // بما أننا لا نستطيع قراءة ال-response في وضع no-cors
          // سنقوم بحفظ اسم المستخدم المدخل مؤقتاً وننتقل لصفحة الداش بورد
          // صفحة الداش بورد ستقوم بالتحقق من صحة المستخدم
          // هذا ليس مثالياً ولكنه حل للمشكلة الحالية
          // الحل الأفضل يتطلب استخدام API Gateway أو وسيط آخر
          // سنقوم بتعديل هذا لاحقاً
          
          // الحل المؤقت:
          // لن نقم بإعادة التوجيه من هنا، بل سنعتمد على الخادم
          // هذا الكود لن يتم تنفيذه في وضع no-cors
      })
      .catch(error => {
        // هذا الجزء سيلتقط الأخطاء الشبكية فقط
        errorMsg.textContent = 'خطأ شبكي حاد. تحقق من اتصالك بالإنترنت.';
        loginBtn.disabled = false;
        loginBtn.textContent = 'دخول';
      });

      // سنضيف تأخيرًا بسيطًا ثم نعيد تحميل الصفحة
      // هذا سيعطي فرصة للـ API للعمل
      // إذا نجحت عملية تسجيل الدخول، فإن localStorage سيحتوي على البريد الإلكتروني
      // وسيقوم الجزء العلوي من السكربت بإعادة التوجيه إلى dashboard.html
      setTimeout(() => {
          // سنقوم بإعادة تحميل الصفحة بعد ثانيتين
          // إذا نجح تسجيل الدخول، سيتم إعادة التوجيه إلى الداش بورد
          // إذا فشل، ستبقى في صفحة تسجيل الدخول
          // وسنحتاج للنظر في السجلات (Logs) لمعرفة السبب
          
          // سنقوم بتعديل هذا الجزء لاحقاً ليكون أكثر احترافية
          // حالياً، سنقوم بإعادة تحميل الصفحة
          // window.location.reload();
          
          // تعديل: لن نقم بإعادة التحميل، سننتظر الرد من الخادم
          // هذا الكود أعلاه كان مجرد فكرة للتجربة
          // الكود الصحيح هو الذي يعتمد على الرد من الخادم
          // بما أننا لا نستطيع قراءة الرد، سنعتمد على السجلات
          
          // سنقوم بإعادة الكود إلى حالته الطبيعية مع بعض التعديلات
          // هذا هو الكود الصحيح الذي يجب أن يعمل
          fetch(API_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'text/plain;charset=utf-8',
              },
              body: JSON.stringify({ action: 'login', username: username, password: password })
          })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                  localStorage.setItem('userEmail', data.email);
                  window.location.href = 'dashboard.html';
              } else {
                  errorMsg.textContent = data.message;
                  loginBtn.disabled = false;
                  loginBtn.textContent = 'دخول';
              }
          })
          .catch(err => {
              errorMsg.textContent = "خطأ فادح. راجع السجلات (Logs).";
              loginBtn.disabled = false;
              loginBtn.textContent = 'دخول';
          });
      });
    });
  </script>
</body>
</html>
