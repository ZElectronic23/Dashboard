<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم</title>
  <!-- بقية الـ head يبقى كما هو -->
</head>
<body>
  <!-- بقية الـ body يبقى كما هو -->
  <div class="top-bar">...</div>
  <div class="container">...</div>

  <script>
    function logout() {
      localStorage.removeItem('userEmail');
      window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // --- خطوة 1: هل بدأت الصفحة بالعمل؟ ---
      alert("الخطوة 1: صفحة dashboard.html بدأت بالعمل.");

      const userEmail = localStorage.getItem('userEmail');

      // --- خطوة 2: هل وجدنا البريد الإلكتروني في الذاكرة؟ ---
      if (!userEmail) {
        alert("الخطوة 2: فشل! لم يتم العثور على userEmail في localStorage. سيتم تسجيل الخروج.");
        logout();
        return;
      }
      
      alert(`الخطوة 2: نجاح! تم العثور على البريد: [${userEmail}]`);

      // **استخدم الرابط الجديد هنا**
      const API_URL = "https://script.google.com/macros/s/AKfycbzcjXMeSubNDfGl0vY3-GwV29xw7SnSRj_UrsUa0mIv0MHiue5hCy79AijTNh6N793/exec"; // تأكد من أنه الرابط الجديد

      const urlWithParams = new URL(API_URL );
      urlWithParams.searchParams.append('action', 'getUserData');
      urlWithParams.searchParams.append('email', userEmail);

      // --- خطوة 3: هل سيتم إرسال الطلب؟ ---
      alert(`الخطوة 3: سيتم الآن إرسال طلب fetch إلى: ${urlWithParams.href}`);

      fetch(urlWithParams)
      .then(response => {
        // --- خطوة 4: هل استقبلنا ردًا من الخادم؟ ---
        alert(`الخطوة 4: تم استقبال رد من الخادم. الحالة: ${response.status}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // --- خطوة 5: ما هو محتوى الرد؟ ---
        alert(`الخطوة 5: تم تحليل الرد. success = ${data.success}. Message = ${data.message || 'لا يوجد'}`);

        if (data.success) {
          // ... الكود الخاص بتعبئة البيانات ...
          const userData = data.data;
          document.getElementById('userName').textContent = userData.empName;
          document.getElementById('empName').textContent = userData.empName;
          // ... بقية الكود
          alert("الخطوة 6: نجاح كامل! تم عرض البيانات.");
        } else {
          alert('الخطوة 6: فشل! الخادم أرجع success: false. الرسالة: ' + data.message);
          logout();
        }
      })
      .catch(error => {
        // --- خطوة X: هل حدث خطأ كارثي؟ ---
        alert('خطوة X: حدث خطأ كارثي في fetch. الخطأ: ' + error.toString());
        logout();
      });
    });
  </script>
</body>
</html>
