<!DOCTYPE html>
<!-- السمة dir و lang سيتم تغييرها بواسطة JavaScript -->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة الموظف | Employee Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{--gold:#dba935;--silver:#c0c0c0;--light:#f0f0f0;--dark:#222}
    body{margin:0;font-family:'Alata',sans-serif;background-image:url("https://i.ibb.co/PS9M6NX/BG2-Phone.png" );background-size:cover;background-attachment:fixed;background-repeat:no-repeat;color:var(--light);min-height:100vh;transition: all 0.3s ease;}
    .top-bar{position:fixed;top:0;width:100%;background:rgba(0,0,0,.6);display:flex;justify-content:space-between;align-items:center;padding:10px 20px;color:var(--gold);font-size:18px;gap:15px;box-shadow:0 0 10px rgba(0,0,0,.8);z-index:1000;box-sizing:border-box}
    .top-bar-left, .top-bar-right { display: flex; align-items: center; gap: 20px; }
    .datetime-widget { display: flex; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 16px; color: var(--light); }
    .datetime-widget .material-icons { font-size: 20px; color: var(--gold); }
    .lang-switcher { cursor: pointer; font-weight: bold; font-size: 16px; background-color: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; color: var(--gold); user-select: none; }
    .container{margin:90px auto 40px;padding:20px;max-width:900px;background:rgba(0,0,0,.5);border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,.7)}
    h2{color:var(--gold);margin-bottom:10px}
    .profile-section{display:flex;align-items:center;gap:20px;margin-bottom:25px;flex-wrap:wrap}
    .profile-img{width:100px;height:100px;border-radius:50%;border:2px solid var(--gold);object-fit:cover;box-shadow:0 0 10px var(--gold)}
    .profile-data p{margin:4px 0;font-size:18px}
    .cards{display:flex;gap:20px;flex-wrap:wrap; justify-content: center;}
    .card{background:var(--dark);flex:1 1 150px;max-width:150px;border-radius:12px;text-align:center;padding:15px 10px;cursor:pointer;box-shadow:0 0 10px rgba(219,169,53,.7);transition:transform .3s;color:var(--gold);display:none}
    .card.active{display:block}
    .card:hover{transform:scale(1.05);background:var(--gold);color:var(--dark);box-shadow:0 0 20px rgba(219,169,53,1)}
    .card i.material-icons{font-size:48px;margin-bottom:8px}
    /* لتغيير اتجاه النص عند التحويل للإنجليزية */
    html[dir="ltr"] .top-bar { flex-direction: row-reverse; }
    html[dir="ltr"] .profile-section { text-align: left; }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-left">
        <div class="lang-switcher" id="lang-switcher" title="Switch Language">EN</div>
    </div>
    <div class="top-bar-right">
        <div class="datetime-widget">
            <span id="time-icon" class="material-icons"></span>
            <span id="time"></span>
            <span id="date"></span>
        </div>
        <div><span data-translate="welcome">مرحباً</span>، <span id="userName">...</span></div>
        <button onclick="logout()" style="background:none; border:none; color:var(--gold);font-size:16px; cursor:pointer;" data-translate="logout">تسجيل خروج</button>
    </div>
  </div>

  <div class="container">
    <div class="profile-section">
      <img id="profileImg" class="profile-img" src="https://i.ibb.co/6n0x9G6/user.png" alt="صورة المستخدم" />
      <div class="profile-data">
        <h2 id="empName">جاري التحميل...</h2>
        <p><span data-translate="job_title">المسمى الوظيفي</span>: <span id="empJob">...</span></p>
        <p><span data-translate="email">البريد الإلكتروني</span>: <span id="empEmail">...</span></p>
      </div>
    </div>
    <div class="cards">
      <div id="cardProjects" class="card"><i class="material-icons">folder</i><span data-translate="projects">المشاريع</span></div>
      <div id="cardTimeline" class="card"><i class="material-icons">timeline</i><span data-translate="timeline">الجدول الزمني</span></div>
      <div id="cardReports" class="card"><i class="material-icons">bar_chart</i><span data-translate="reports">التقارير</span></div>
      <div id="cardContracts" class="card"><i class="material-icons">gavel</i><span data-translate="contracts">العقود</span></div>
      <div id="cardViolations" class="card"><i class="material-icons">error</i><span data-translate="violations">المخالفات</span></div>
    </div>
  </div>

  <script>
    // --- قاموس الترجمة ---
    const translations = {
      ar: {
        welcome: "مرحباً",
        logout: "تسجيل خروج",
        job_title: "المسمى الوظيفي",
        email: "البريد الإلكتروني",
        projects: "المشاريع",
        timeline: "الجدول الزمني",
        reports: "التقارير",
        contracts: "العقود",
        violations: "المخالفات",
        loading: "جاري التحميل...",
        fetch_error: "حدث خطأ أثناء جلب بياناتك. يرجى تسجيل الدخول مرة أخرى.",
        connection_error: "فشل الاتصال بالخادم. يرجى المحاولة مرة أخرى."
      },
      en: {
        welcome: "Welcome",
        logout: "Logout",
        job_title: "Job Title",
        email: "Email",
        projects: "Projects",
        timeline: "Timeline",
        reports: "Reports",
        contracts: "Contracts",
        violations: "Violations",
        loading: "Loading...",
        fetch_error: "Error fetching your data. Please log in again.",
        connection_error: "Server connection failed. Please try again."
      }
    };

    // --- إدارة اللغة ---
    const langSwitcher = document.getElementById('lang-switcher' );
    let currentLang = localStorage.getItem('lang') || 'ar';

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      
      document.documentElement.setAttribute('lang', lang);
      document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
      
      langSwitcher.textContent = lang === 'ar' ? 'EN' : 'ع';

      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });
    }

    langSwitcher.addEventListener('click', () => {
      const newLang = currentLang === 'ar' ? 'en' : 'ar';
      setLanguage(newLang);
    });

    // --- إدارة الساعة والتاريخ ---
    function updateClock() {
      const timeEl = document.getElementById('time');
      const dateEl = document.getElementById('date');
      const iconEl = document.getElementById('time-icon');
      
      // توقيت مصر (UTC+3)
      const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Africa/Cairo"}));
      
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';

      // تحديد أيقونة الشمس أو القمر
      iconEl.textContent = (hours >= 6 && hours < 18) ? 'wb_sunny' : 'nightlight_round';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // الساعة 0 تكون 12
      const hoursStr = hours.toString().padStart(2, '0');

      timeEl.textContent = `${hoursStr}:${minutes}:${seconds} ${ampm}`;
      dateEl.textContent = now.toLocaleDateString(currentLang === 'ar' ? 'ar-EG' : 'en-GB');
    }

    // --- دالة تسجيل الخروج ---
    function logout() {
      localStorage.removeItem('userEmail');
      window.location.href = 'index.html';
    }

    // --- جلب بيانات المستخدم عند تحميل الصفحة ---
    document.addEventListener('DOMContentLoaded', function() {
      // تطبيق اللغة المحفوظة عند التحميل
      setLanguage(currentLang);
      // تحديث الساعة فورًا ثم كل ثانية
      updateClock();
      setInterval(updateClock, 1000);

      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail) {
        logout();
        return;
      }

      const API_URL = "https://script.google.com/macros/s/AKfycbxzcjXMeSubNDfGl0vY3-GwV29xw7SnSRj_UrsUa0mIv0MHiue5hCy79AijTNh6N793/exec";

      // تغيير نص "جاري التحميل" بناءً على اللغة
      document.getElementById('empName' ).textContent = translations[currentLang].loading;

      fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'getUserData', email: userEmail })
      })
      .then(res => res.json())
      .then(response => {
        if (response.success) {
          const userData = response.data;
          document.getElementById('userName').textContent = userData.empName;
          document.getElementById('empName').textContent = userData.empName;
          document.getElementById('empJob').textContent = userData.empJob;
          document.getElementById('empEmail').textContent = userData.empEmail;
          document.getElementById('profileImg').src = userData.profileImg;

          if (userData.permissions.projects) document.getElementById('cardProjects').classList.add('active');
          if (userData.permissions.timeline) document.getElementById('cardTimeline').classList.add('active');
          if (userData.permissions.reports) document.getElementById('cardReports').classList.add('active');
          if (userData.permissions.contracts) document.getElementById('cardContracts').classList.add('active');
          if (userData.permissions.violations) document.getElementById('cardViolations').classList.add('active');
        } else {
          alert(translations[currentLang].fetch_error);
          logout();
        }
      })
      .catch(error => {
        alert(translations[currentLang].connection_error);
        logout();
      });
    });
  </script>
</body>
</html>
